$(document).ready(function(){
    var spheres = [ // ajax later
        [-1.8640352448, -3.4821764360, -2.1394685992],
        [-3.3172785927, -3.4220764097, -0.4275244638],
        [-0.7628384594, -3.3091762382, -4.6875480200],
        [-1.5881711368, -5.3788111587, -2.7110241281],
        [-3.4715951702, -4.5030651351, -2.7506456197],
        [-2.4393797352, -5.2118603525, -0.2663815625],
        [-2.1287425365, -4.7659319575, -4.5772356162],
        [-4.9760915255, -3.2189292921, -1.5261922491],
        [-3.3079040377, 0.1263956755, -3.5903809175],
        [-5.0257731863, -0.7800974564, -2.3004914462],
        [-4.5234168557, -1.1934969302, -4.4737902784],
        [-6.5428103801, -1.7891306872, -1.4755974584],
        [-4.8477281576, -3.1898822384, -3.5218573299],
        [-1.0905505086, -1.6666666666, -1.8144368465],
        [-1.9245008972, -0.0000000001, -1.0886621077],
        [-3.1348340503, -1.3340730311, -1.9577667081],
        [-2.6462027351, -2.2994771554, -3.6397995004],
        [-2.3227910827, -0.3494792733, -5.2646256722],
        [-3.0060758367, -2.9198673444, -5.5067776374],
        [-2.9828022119, 1.4294217236, -2.0034035265],
        [-1.3800826099, 0.2122208078, -3.0648920126],
        [-3.8380005132, 0.2933432657, -0.5861992253],
        [-5.8297017780, 0.3108204475, -0.4050346044],
        [-3.2531510485, 1.5350536319, -5.0090721708],
        [-0.8547634696, 1.5783576641, -6.0999120623],
        [-6.5658385444, 0.4949679057, -2.3495527857],
        [-5.0742264699, 0.7291476768, -4.4669723595],
        [-4.3718083390, 3.2730809261, -3.9445732445],
        [-4.2744023036, 2.4622727295, -0.2916818473],
        [-4.8407058107, 1.8706647616, -2.5979611763],
        [-2.8760815123, 3.3882183581, -2.3929243057],
        [-6.1318590381, 2.3757543604, -1.0281389416],
        [-4.5580696325, 4.3945593728, -0.7227284509],
        [-3.1262876876, 4.8999895437, -3.6782043343],
        [-0.8981004184, 1.7777777778, -1.8144368466],
        [-0.9097341172, 3.4486178304, -2.9135993350],
        [-1.7493303183, 3.4988980688, -4.7281378759],
        [-1.3325626683, 4.4252054243, -0.7809374622],
        [-0.7563174148, 6.2857151036, -1.2352998072],
        [-2.8002599031, 5.5382403828, -1.5600510666],
        [-1.1463829714, 5.3513679647, -3.4824044387],
        [2.2098176596, -5.0071339370, -4.1263637114],
        [4.0162571834, -3.5486957121, -2.8149163937],
        [1.6504669812, -3.1079794805, -3.8429220617],
        [0.2338233327, -4.7288594590, -3.4489216681],
        [4.0761044715, -2.9994365942, -4.7370851491],
        [1.2684280027, -2.9946922682, -5.8028231374],
        [0.4310416006, -3.3673443376, -1.9972393579],
        [-0.0985746968, -4.8050872077, -0.1165984800],
        [0.1591495018, -6.7554961914, -0.4764359898],
        [3.3304709373, -3.6397559189, -0.7161772554],
        [1.6983492181, -4.8853632598, -1.1521455763],
        [3.3644216836, -5.8317028658, -1.7254202831],
        [5.0372920971, -4.6212267805, -1.4706080911],
        [1.1547005384, 0.0000000000, 0],
        [0.9622504485, -1.6666666666, -1.0886621080],
        [0.0164362628, -1.9377590976, -3.4579359131],
        [-0.2996215473, -0.9226149842, -5.1519223031],
        [1.5569290114, -0.0000000003, -2.8883704172],
        [2.4589749019, -2.5069421913, -2.1151868045],
        [4.4816393745, -1.1148081929, -0.7050622684],
        [2.6054603825, -1.1464280231, -4.1478483855],
        [5.0225757322, -0.8756937933, -3.3831607886],
        [5.7223480409, -2.5361771187, -1.3686527907],
        [2.7079445634, -1.3437506702, -6.1354501478],
        [6.1669555392, -0.3408503170, -1.4538603927],
        [0.0000000000, 0.0000000000, -1.6329931618],
        [2.8572579025, 0.0000000002, -1.0494276640],
        [3.5474838509, 0.3806772848, -2.8875443484],
        [4.1429970621, 1.1591402874, -0.0477946934],
        [2.1002468110, 1.3176442920, -4.2914453573],
        [-0.1630434338, 1.2689341879, -4.2490256518],
        [4.5496978488, 0.8004483393, -4.5666391533],
        [1.4843717409, 0.3740234789, -5.9438005428],
        [0.9622504487, 1.6666666665, -1.0886621078],
        [-0.2097730467, 2.9659315821, -0.0000000003],
        [0.7051541727, 4.8752150057, -2.0567794084],
        [1.0546048086, 2.8017280065, -5.9564024365],
        [1.7301641591, 5.7338148579, -3.5696569513],
        [3.2211651076, 2.8040749970, -3.0292857294],
        [1.2995559489, 3.0225403646, -2.5196867460],
        [1.2747160216, 3.9148445723, -4.3094286768],
        [3.3595442894, 2.6057252600, -5.1603626609],
        [4.9886655707, 3.6543302806, -2.6381232748],
        [2.3795034235, 2.7144469193, -0.1433840815],
        [5.0171507270, 1.6141865253, -2.3231559833],
        [5.9430568062, 3.0335978004, -0.3988464555],
        [2.2379306509, 4.6350738416, -0.6829666754],
        [4.0647091759, 3.6911734497, -0.5973519840],
        [3.1212905719, 4.8103858268, -2.4687272858],
        [2.1492630577, 6.4479060646, -1.5230722574],
        [-4.8469956347, -4.6184610376, 0.0506278069],
        [-1.0905505085, -1.6666666666, 1.8144368465],
        [-2.4636855725, -1.6646345788, 0.0000000000],
        [-0.8382888173, -2.9732671087, 0.1952639017],
        [-1.2351193263, -3.6139503398, 2.2470869971],
        [-5.1431122886, -1.5526529439, 1.1197787550],
        [-6.2483159864, -3.0133103108, 0.3166568198],
        [-3.3541951232, -5.8152757759, 1.8502253725],
        [-4.0512937760, -3.7156705549, 2.9616232781],
        [-1.4892039247, -5.5771482070, 2.5322100430],
        [-1.3482994376, -4.1837788211, 4.1608491988],
        [-2.8920396725, -2.1407580498, 2.5423613977],
        [-1.1943751810, -2.1708005816, 3.7470696188],
        [-4.8251888026, -1.1558066408, 3.3078036552],
        [-3.2849793667, -1.9208042418, 4.4910067526],
        [-1.3452132692, -2.4784278724, 5.7175044238],
        [-0.5773502692, -1.0000000000, 0],
        [0.9622504487, -1.6666666665, 1.0886621078],
        [1.0219517571, -2.9967238908, 2.5811042454],
        [1.0627336728, -4.3299626673, 4.0713428841],
        [0.6234080918, -2.1198197469, 5.9847354561],
        [0.7588245889, -5.7973111650, 2.4732744696],
        [1.2724020081, -3.3566672550, 0.0650879672],
        [2.7814367557, -2.4445366013, 1.3810309589],
        [1.9473934985, -4.9064490175, 1.1339953421],
        [4.6044774055, -3.2451043261, 1.1923139566],
        [5.1269710682, -0.8077115484, 1.1628881207],
        [3.7834297496, -5.5976775232, 0.7451842856],
        [6.6168687205, -2.0832288578, 0.6047782740],
        [1.2451098423, -1.4828508863, 4.1937140705],
        [2.8089768869, -3.8635508907, 2.8159491685],
        [2.3017323869, -3.4138671049, 5.3463531224],
        [5.8964170713, -2.3758491167, 2.4474184466],
        [3.7137964041, -0.7294815094, 2.7029688706],
        [4.0748128262, -2.2549314470, 3.9450113947],
        [2.9969493359, -0.5946000860, 5.6861488798],
        [-1.9245008970, 0.0000000000, 1.0886621080],
        [-1.4326840012, -0.1111111115, 3.0240614109],
        [-3.7481621220, -0.3171048585, 1.8460947751],
        [-3.2439359344, 0.4350171673, 3.6729915597],
        [-5.3134902043, 0.8872193373, 2.1612950696],
        [-1.2735921696, -0.3904473018, 4.9980576322],
        [-3.8067215784, 0.6276601183, 5.5824839038],
        [-1.7997670515, 0.9032788178, 6.4296346371],
        [-0.8981004186, 1.7777777775, 1.8144368467],
        [-2.4636855725, 1.6646345788, 0.0000000000],
        [-2.7432530464, 2.0305057237, 2.5435049954],
        [-1.4326716414, 1.9760979157, 4.7462034571],
        [-4.8840325305, 1.4956076909, 4.1033761517],
        [-3.0635453542, 2.6333832354, 5.6992128702],
        [-3.1240531221, 4.5307889529, 1.5438908699],
        [-1.3774424384, 3.7039745639, 2.0593800412],
        [-0.9345614219, 5.6446565768, 2.2533123227],
        [-1.9072827145, 4.1598037917, 3.9332767824],
        [-3.8080335399, 3.1892246244, 3.7778521953],
        [-5.4304820070, 3.3351724194, 1.0872764012],
        [-2.0563821444, 5.9208103611, 0.3322791562],
        [-0.5773502692, 1.0000000000, 0],
        [0.0000000000, 0.0000000000, 1.6329931618],
        [0.9622504487, 1.6666666665, 1.0886621078],
        [-0.0296969775, 1.2310006189, 3.5310935400],
        [0.4015490935, 4.3433157788, 1.3149517157],
        [1.0529877311, 3.7137251067, 4.2068584483],
        [0.5773606222, 1.8345337110, 5.3386412924],
        [1.0093248309, 5.9392210953, 0.2739450523],
        [-0.1362403670, 5.3012500133, 4.4627904726],
        [0.2589257768, -0.0704268369, 6.2426361337],
        [2.8572579027, 0.0000000002, 1.0494276637],
        [1.5569290115, 0.0000000003, 2.8883704172],
        [3.5305179099, 1.5209922592, 2.1599696533],
        [2.3254466712, 0.8788508836, 4.5122551827],
        [6.0431198931, 0.8995503454, 0.5197846299],
        [5.1268881504, -0.4712864356, 4.0945532269],
        [1.7032656657, 2.8380422740, 2.5304580831],
        [3.1113096728, 4.0031746346, 1.1996127498],
        [1.8890586242, 5.3092388833, 2.2392395239],
        [5.0163123602, 3.4181651288, 1.3691079974],
        [3.6184083181, 5.8908934631, 0.7760934603],
        [2.9398556601, 2.3478869701, 5.7223934273],
        [3.4843234390, 3.4017905705, 3.2446156752],
        [5.4881252227, 1.5213954918, 2.5695712238],
        [4.1668029012, 1.5367878878, 4.0921050517],
        [2.5960043650, 4.9820495364, 4.1046194692]
    ];
    var setHeight = function(){
        $('#viewport').height(.98*$(window).height()-$('#controls').height());
        //$('#controls').height();
    }
    var drawSlice = function(z){
        var h = $('#viewport').height() < $('#viewport').width() ? $('#viewport').height() : $('#viewport').width();
        var w = h;
        var cx = $('#viewport').width()/2,
            cy = $('#viewport').height()/2;
        var radius       = 8;
        var grain_radius = 1;
        var r = h*grain_radius/radius;
        z *= radius;
        $('canvas')
        .clearCanvas({
            x:cx, y:cy,
            height: $('#viewport').height(),
            width: $('#viewport').width()
        })
        .drawArc({
            strokeStyle: "#000",
            strokeWidth: 1,
            x: cx, y: cy,
            radius: Math.sqrt(Math.pow(radius,2) - Math.pow(z,2))/radius*h/2
        });
        for(var i=0; i<spheres.length; i++){
            if((Math.pow(grain_radius,2) - Math.pow(spheres[i][2]-z,2))>0){
                $('canvas')
                .drawArc({
                    strokeStyle: "#000",
                    strokeWidth: 1,
                    x: cx+spheres[i][0]/radius*h/2,
                    y: cy+spheres[i][1]/radius*h/2,
                    radius: Math.sqrt(Math.pow(grain_radius,2) - Math.pow(spheres[i][2]-z,2))/radius*h/2
                });
            }
        }
    }
    setHeight();
    drawSlice(0);
    $(window).resize(function(){setHeight();drawSlice(0);});
    $('#controls div.z').html(($("#controls input.z").val()-50)/50+"R");
    $('#controls input.z').change(function(){ // 'Instantaneous' if switch to jQuery UI
        $('#controls div.z').html(($(this).val()-50)/50+"R");
        drawSlice(($(this).val()-50)/50)
    });
})